<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Corning Apps</title>
    
    <!-- Cargamos Tailwind CSS -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- --- CAMBIO AQUÍ --- -->
    <!-- Google Font para la firma -->
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link href="https://fonts.googleapis.com/css2?family=Dancing+Script:wght@400..700&display=swap" rel="stylesheet">
    
    <!-- SortableJS (Para arrastrar y soltar) -->
    <script src="https://cdn.jsdelivr.net/npm/sortablejs@latest/Sortable.min.js"></script>
    <!-- --- FIN DEL CAMBIO --- -->

    <style>
        /* Estilos personalizados (fondo, fuente de título, modales) */
        body {
            background: linear-gradient(to bottom, #002244, #000000);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            color: #E5E7EB;
            min-height: 100vh;
        }

        .titulo-principal {
            font-family: 'Times New Roman', Times, serif;
            font-weight: 400;
            cursor: pointer;
            user-select: none;
            display: inline-block;
        }
        
        .font-signature {
            font-family: 'Dancing Script', cursive;
        }

        /* Estilos para las tarjetas de apps */
        .app-card {
            background: rgba(255, 255, 255, 0.05);
            border: 1px solid rgba(255, 255, 255, 0.1);
            backdrop-filter: blur(8px);
            transition: all 0.3s ease-in-out;
            display: flex;
            flex-direction: column;
            align-items: center;
            text-align: center;
            padding: 1.5rem;
            border-radius: 1rem;
            height: 100%;
            /* --- CAMBIO AQUÍ (Animación de entrada) --- */
            opacity: 0; /* Oculto al inicio para la animación */
        }
        .app-card:hover {
            transform: scale(1.05);
            background: rgba(255, 255, 255, 0.15);
        }
        
        .app-card img {
             width: 10rem; /* 160px */
             height: 10rem; /* 160px */
             border-radius: 1.25rem;
             margin-bottom: 1.5rem;
             object-fit: cover;
             background-color: rgba(255, 255, 255, 0.2);
             /* --- CAMBIO AQUÍ (Efecto de icono) --- */
             transition: transform 0.4s cubic-bezier(0.175, 0.885, 0.32, 1.275);
        }
        
        /* Efecto de giro en icono (Sugerencia) */
        .app-card:hover img {
            transform: scale(1.05) rotate(10deg);
        }
        /* --- FIN DEL CAMBIO --- */
        
        .app-card-nombre {
            font-size: 1.125rem; /* text-lg */
            font-weight: 600; /* semibold */
            color: white;
            margin-bottom: 0.25rem;
        }
        .app-card-desc {
            font-size: 0.875rem; /* text-sm */
            color: #D1D5DB; /* gray-300 */
            flex-grow: 1; 
        }

        /* --- CAMBIO AQUÍ (Animación de entrada) --- */
        @keyframes fadeInUp {
            from {
                opacity: 0;
                transform: translateY(30px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
        .card-fade-in {
            animation: fadeInUp 0.5s ease-out forwards;
        }
        /* --- FIN DEL CAMBIO --- */

        /* --- CAMBIO AQUÍ (Estilos para SortableJS) --- */
        /* Estilo del "fantasma" (dónde va a caer el item) */
        .sortable-ghost {
            opacity: 0.4;
            background-color: rgba(0, 100, 255, 0.3);
            border: 2px dashed rgba(255, 255, 255, 0.5);
            border-radius: 1rem;
        }
        /* Estilo del item que estás arrastrando */
        .sortable-chosen {
            cursor: grabbing !important;
            transform: scale(1.05);
            box-shadow: 0 10px 30px rgba(0, 0, 0, 0.3);
        }
        /* Cursor de "agarrar" solo para admin */
        .admin-sortable .app-card {
            cursor: grab !important;
        }
        /* --- FIN DEL CAMBIO --- */
        
        /* Estilos de Modales (Sin cambios) */
        .modal {
            display: none; 
            position: fixed;
            z-index: 1000;
            left: 0;
            top: 0;
            width: 100%;
            height: 100%;
            overflow: auto;
            background-color: rgba(0, 0, 0, 0.6);
            backdrop-filter: blur(5px);
            align-items: center;
            justify-content: center;
        }
        .modal-content {
            background-color: #1F2937;
            color: #E5E7EB;
            margin: auto;
            padding: 2rem;
            border: 1px solid rgba(255, 255, 255, 0.1);
            width: 90%;
            max-width: 500px;
            border-radius: 1rem;
            box-shadow: 0 10px 25px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        .modal-close {
            color: #aaa;
            position: absolute;
            top: 1rem;
            right: 1.25rem;
            font-size: 28px;
            font-weight: bold;
            cursor: pointer;
            line-height: 1;
        }
        .modal-close:hover,
        .modal-close:focus {
            color: #fff;
            text-decoration: none;
        }

        /* Formularios y Botones (Sin cambios) */
        .form-input {
            width: 100%;
            background-color: #374151;
            border: 1px solid #4B5563;
            color: #E5E7EB;
            border-radius: 0.5rem;
            padding: 0.75rem 1rem;
            margin-top: 0.25rem;
        }
        .form-input:focus {
            background-color: #4B5563;
            border-color: #3B82F6;
            outline: none;
            box-shadow: 0 0 0 2px rgba(59, 130, 246, 0.5);
        }
        .form-label {
            color: #D1D5DB;
            font-weight: 500;
        }
        .btn-primary {
            width: 100%;
            background-color: #3B82F6;
            color: white;
            font-weight: 600;
            padding: 0.75rem;
            border-radius: 0.5rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-primary:hover {
            background-color: #2563EB;
        }
        .btn-danger {
            background-color: #EF4444;
            color: white;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-danger:hover {
            background-color: #DC2626;
        }
        .btn-secondary {
            background-color: #4B5563;
            color: white;
            font-weight: 500;
            padding: 0.25rem 0.75rem;
            border-radius: 0.375rem;
            border: none;
            cursor: pointer;
            transition: background-color 0.2s;
        }
        .btn-secondary:hover {
            background-color: #6B7280;
        }
        #admin-gear {
            display: none; 
            position: fixed;
            top: 1.5rem;
            right: 1.5rem;
            z-index: 900;
            cursor: pointer;
            color: #9CA3AF;
            transition: all 0.2s ease-in-out;
        }
        #admin-gear:hover {
            color: #fff;
            transform: scale(1.1) rotate(15deg);
        }
        #admin-app-list {
            max-height: 300px;
            overflow-y: auto;
            margin-top: 1.5rem;
            padding-right: 0.5rem; 
        }
        .admin-list-item {
            background-color: #374151;
            padding: 0.75rem 1rem;
            border-radius: 0.5rem;
            display: flex;
            justify-content: space-between;
            align-items: center;
            margin-bottom: 0.5rem;
        }
        .admin-list-item span {
            font-weight: 500;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
            padding-right: 1rem;
        }
        .admin-list-item .btn-group {
            display: flex;
            gap: 0.5rem;
            flex-shrink: 0;
        }
        .error-message {
            color: #F87171; 
            font-size: 0.875rem;
            margin-top: 1rem;
            text-align: center;
            display: none; 
        }
    </style>
</head>
<body class="min-h-screen">

    <!-- Botón de Engrane (Admin) -->
    <div id="admin-gear">
        <svg xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24" stroke-width="1.5" stroke="currentColor" class="w-10 h-10">
            <path stroke-linecap="round" stroke-linejoin="round" d="M10.5 6h9.75M10.5 6a1.5 1.5 0 1 1-3 0m3 0a1.5 1.5 0 1 0-3 0M3.75 6H7.5m3 12h9.75m-9.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-3.75 0H7.5m9-6h3.75m-3.75 0a1.5 1.5 0 0 1-3 0m3 0a1.5 1.5 0 0 0-3 0m-9.75 0h9.75" />
        </svg>
    </div>

    <!-- Contenedor Principal -->
    <div class="container mx-auto px-4 py-12">

        <!-- Título Principal (Botón de Login) -->
        <div class="text-center mb-12">
            
            <!-- Título reducido -->
            <h1 id="login-trigger" class="titulo-principal text-3xl md:text-4xl text-white">
                CORNING APPS
            </h1>
            <!-- Texto "Powered by" con fuente de firma -->
            <p class="text-base text-white opacity-30 font-light tracking-wide mt-3 font-signature">
                Powered By Ulises Luna
            </p>
            
        </div>
        
        <!-- Galería de Aplicaciones -->
        <div id="app-gallery" class="grid grid-cols-1 sm:grid-cols-2 md:grid-cols-3 lg:grid-cols-4 xl:grid-cols-5 gap-6 md:gap-8">
            <!-- Las aplicaciones se cargarán aquí desde Firebase -->
            <p id="loading-apps" class="text-center col-span-full">Cargando aplicaciones...</p>
        </div> <!-- Fin de la galería -->

    </div> <!-- Fin del contenedor principal -->

    <!-- Modales (Login y Admin) ... (Sin cambios) -->
    <div id="login-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="login-close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-center text-white">Iniciar Sesión</h2>
            <form id="login-form">
                <div class="mb-4">
                    <label for="email" class="form-label">Correo Electrónico</label>
                    <input type="email" id="login-email" class="form-input" required>
                </div>
                <div class="mb-6">
                    <label for="password" class="form-label">Contraseña</label>
                    <input type="password" id="login-password" class="form-input" required>
                </div>
                <button type="submit" class="btn-primary">Entrar</button>
                <p id="login-error" class="error-message">Error: Usuario o contraseña incorrectos.</p>
            </form>
        </div>
    </div>

    <div id="admin-modal" class="modal">
        <div class="modal-content">
            <span class="modal-close" id="admin-close">&times;</span>
            <h2 class="text-2xl font-bold mb-6 text-white">Administración de Apps</h2>
            
            <form id="admin-form" class="space-y-4">
                <input type="hidden" id="edit-id"> 
                
                <div>
                    <label for="app-nombre" class="form-label">Nombre de la App</label>
                    <input type="text" id="app-nombre" class="form-input" required>
                </div>
                
                <div>
                    <label for="app-icono" class="form-label">Nombre del Ícono (ej. icono.png)</label>
                    <input type="text" id="app-icono" class="form-input" placeholder="ej: cro.png" required>
                </div>
                
                <div>
                    <label for="app-desc" class="form-label">Descripción Breve</label>
                    <textarea id="app-desc" class="form-input" rows="2"></textarea>
                </div>

                <div>
                    <label for="app-link" class="form-label">Enlace (URL)</label>
                    <input type="url" id="app-link" class="form-input" placeholder="https://..." required>
                </div>

                <button type="submit" id="admin-form-submit" class="btn-primary !mt-6">Guardar App</button>
                <button type="button" id="admin-form-cancel" class="btn-secondary w-full" style="display: none;">Cancelar Edición</button>
            </form>
            
            <hr class="border-gray-600 my-6">
            
            <h3 class="text-xl font-bold mb-4 text-white">Apps Actuales</h3>
            <div id="admin-app-list">
                <!-- Los items de la lista se cargarán aquí -->
            </div>

            <button id="logout-button" class="btn-danger w-full !mt-6">Cerrar Sesión</button>
        </div>
    </div>
    
    <!-- Scripts de Firebase -->
    <script type="module">
        // Importamos las funciones de Firebase (SDK modular v10+)
        import { initializeApp } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-app.js";
        import { 
            getAuth, 
            signInWithEmailAndPassword, 
            signOut, 
            onAuthStateChanged 
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-auth.js";
        import { 
            getFirestore, 
            collection, 
            onSnapshot, 
            addDoc, 
            doc, 
            updateDoc, 
            deleteDoc,
            serverTimestamp,
            // --- CAMBIO AQUÍ (Nuevas importaciones) ---
            query,
            orderBy,
            getDocs,
            writeBatch
            // --- FIN DEL CAMBIO ---
        } from "https://www.gstatic.com/firebasejs/10.12.2/firebase-firestore.js";

        // Tu configuración de Firebase
        const firebaseConfig = {
            apiKey: "AIzaSyDtlj3ppT9WBGMR60SZx0TZmAo3BXQWDX0",
            authDomain: "rastreador-de-ordenes.firebaseapp.com",
            databaseURL: "https://rastreador-de-ordenes-default-rtdb.firebaseio.com",
            projectId: "rastreador-de-ordenes",
            storageBucket: "rastreador-de-ordenes.firebasestorage.app",
            messagingSenderId: "956052823395",
            appId: "1:956052823395:web:9f5585de67784b413cc756"
        };

        // Inicializar Firebase
        const app = initializeApp(firebaseConfig);
        const auth = getAuth(app);
        const db = getFirestore(app);

        // Referencia a la colección de 'apps'
        const appsCollection = collection(db, "apps");

        // --- REFERENCIAS AL DOM (Sin cambios) ---
        const loginModal = document.getElementById("login-modal");
        const adminModal = document.getElementById("admin-modal");
        const loginTrigger = document.getElementById("login-trigger");
        const adminGear = document.getElementById("admin-gear");
        const loginCloseBtn = document.getElementById("login-close");
        const adminCloseBtn = document.getElementById("admin-close");
        const loginForm = document.getElementById("login-form");
        const adminForm = document.getElementById("admin-form");
        const editIdInput = document.getElementById("edit-id");
        const appNombreInput = document.getElementById("app-nombre");
        const appIconoInput = document.getElementById("app-icono");
        const appDescInput = document.getElementById("app-desc");
        const appLinkInput = document.getElementById("app-link");
        const adminFormSubmitBtn = document.getElementById("admin-form-submit");
        const adminFormCancelBtn = document.getElementById("admin-form-cancel");
        const appGallery = document.getElementById("app-gallery");
        const adminAppList = document.getElementById("admin-app-list");
        const loadingAppsMsg = document.getElementById("loading-apps");
        const logoutButton = document.getElementById("logout-button");
        const loginErrorMsg = document.getElementById("login-error");

        // --- CAMBIO AQUÍ (Variables para Sortable y Conteo) ---
        let sortable = null;
        let currentAppCount = 0; // Para asignar el 'orden' a apps nuevas
        // --- FIN DEL CAMBIO ---

        // --- LÓGICA DE MODALES (Sin cambios) ---
        function openModal(modal) { modal.style.display = "flex"; }
        function closeModal(modal) { modal.style.display = "none"; }
        loginTrigger.addEventListener("click", () => openModal(loginModal));
        adminGear.addEventListener("click", () => openModal(adminModal));
        loginCloseBtn.addEventListener("click", () => closeModal(loginModal));
        adminCloseBtn.addEventListener("click", () => closeModal(adminModal));
        window.addEventListener("click", (event) => {
            if (event.target == loginModal) closeModal(loginModal);
            if (event.target == adminModal) closeModal(adminModal);
        });

        // --- LÓGICA DE AUTENTICACIÓN (Modificada) ---
        onAuthStateChanged(auth, (user) => {
            if (user) {
                // Usuario logueado
                console.log("Usuario autenticado:", user.email);
                adminGear.style.display = "block";
                closeModal(loginModal); 
                loginForm.reset(); 
                loginErrorMsg.style.display = "none";

                // --- CAMBIO AQUÍ (Activar Drag-and-Drop) ---
                appGallery.classList.add("admin-sortable"); // Añade cursor 'grab'
                if (!sortable) {
                    initSortable();
                }
                // --- FIN DEL CAMBIO ---

            } else {
                // Usuario deslogueado
                console.log("Usuario no autenticado.");
                adminGear.style.display = "none"; 
                closeModal(adminModal); 

                // --- CAMBIO AQUÍ (Desactivar Drag-and-Drop) ---
                appGallery.classList.remove("admin-sortable");
                if (sortable) {
                    sortable.destroy();
                    sortable = null;
                }
                // --- FIN DEL CAMBIO ---
            }
        });

        // Formulario de login (Sin cambios)
        loginForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            const email = document.getElementById("login-email").value;
            const password = document.getElementById("login-password").value;
            loginErrorMsg.style.display = "none"; 

            try {
                await signInWithEmailAndPassword(auth, email, password);
            } catch (error) {
                console.error("Error al iniciar sesión:", error.message);
                loginErrorMsg.textContent = "Error: " + error.message;
                loginErrorMsg.style.display = "block";
            }
        });

        // Cerrar sesión (Sin cambios)
        logoutButton.addEventListener("click", async () => {
            try {
                await signOut(auth);
            } catch (error) {
                console.error("Error al cerrar sesión:", error);
            }
        });

        // --- LÓGICA DE FIRESTORE (Modificada) ---

        // C (Create) y U (Update)
        adminForm.addEventListener("submit", async (e) => {
            e.preventDefault();
            
            const appId = editIdInput.value;
            let appData;

            if (appId) {
                // Estamos actualizando (no modificamos el 'orden' aquí, se hace al arrastrar)
                appData = {
                    nombre: appNombreInput.value,
                    icono: appIconoInput.value,
                    descripcion: appDescInput.value,
                    link: appLinkInput.value,
                    // No tocamos 'creadoEn' ni 'orden'
                };
            } else {
                // --- CAMBIO AQUÍ (Asignar 'orden' al crear) ---
                // Estamos creando
                appData = {
                    nombre: appNombreInput.value,
                    icono: appIconoInput.value,
                    descripcion: appDescInput.value,
                    link: appLinkInput.value,
                    creadoEn: serverTimestamp(),
                    orden: currentAppCount // Asigna el siguiente número de orden
                };
                // --- FIN DEL CAMBIO ---
            }
            
            try {
                if (appId) {
                    // --- UPDATE ---
                    const appRef = doc(db, "apps", appId);
                    await updateDoc(appRef, appData);
                    console.log("App actualizada con ID:", appId);
                } else {
                    // --- CREATE ---
                    const docRef = await addDoc(appsCollection, appData);
                    console.log("App guardada con ID:", docRef.id);
                }
                resetAdminForm(); // Limpia el formulario
                
            } catch (error) {
                console.error("Error al guardar la app:", error);
            }
        });

        // --- CAMBIO AQUÍ (Query con orderBy) ---
        // R (Read) - Cargar apps en tiempo real, ORDENADAS
        const q = query(appsCollection, orderBy("orden")); // ¡REQUIERE ÍNDICE!
        
        onSnapshot(q, (snapshot) => {
            // --- FIN DEL CAMBIO ---
            
            currentAppCount = snapshot.size; // Actualiza el conteo global
            
            if (snapshot.empty) {
                appGallery.innerHTML = ""; // Limpia
                loadingAppsMsg.textContent = "No hay aplicaciones para mostrar.";
                loadingAppsMsg.style.display = "block";
                return;
            }
            
            loadingAppsMsg.style.display = "none";
            appGallery.innerHTML = ""; 
            adminAppList.innerHTML = ""; 
            
            snapshot.docs.forEach((doc, index) => { // 'index' se usará para la animación
                const app = doc.data();
                const id = doc.id;
                
                // --- CAMBIO AQUÍ (Pasamos 'index' a la función) ---
                renderAppCard(app, id, index); 
                // --- FIN DEL CAMBIO ---
                
                renderAdminListItem(app, id);
            });
        }, (error) => {
            // --- CAMBIO AQUÍ (Manejo de error de índice) ---
            console.error("Error al leer de Firestore: ", error);
            loadingAppsMsg.innerHTML = `
                <p class="text-red-400">Error al cargar apps.</p>
                <p class="text-sm text-yellow-300 mt-2">
                    Si es la primera vez que usas el orden,
                    <strong class="font-bold">revisa la consola (F12)</strong>.
                    Firebase te dará un <strong class="font-bold">enlace</strong> 
                    para crear el índice necesario.
                </p>
            `;
            loadingAppsMsg.style.display = "block";
            // --- FIN DEL CAMBIO ---
        });

        // Renderizar tarjeta en galería (Modificada)
        function renderAppCard(app, id, index) { // 'index' para la animación
            const card = document.createElement("a");
            card.href = app.link;
            card.target = "_blank";
            card.rel = "noopener noreferrer";
            card.className = "app-card";
            card.setAttribute("data-id", id);
            
            // --- CAMBIO AQUÍ (Animación de entrada escalonada) ---
            card.classList.add("card-fade-in");
            card.style.animationDelay = `${index * 80}ms`; // 80ms de retraso entre tarjetas
            // --- FIN DEL CAMBIO ---
            
            card.innerHTML = `
                <img src="${app.icono}" 
                     alt="Icono de ${app.nombre}"
                     onerror="this.src='https://placehold.co/160x160/FFFFFF/333333?text=${app.nombre.charAt(0)}'">
                <span class="app-card-nombre">${app.nombre}</span>
                <span class="app-card-desc">${app.descripcion}</span>
            `;
            appGallery.appendChild(card);
        }

        // Renderizar item en lista de admin (Sin cambios)
        function renderAdminListItem(app, id) {
            const item = document.createElement("div");
            item.className = "admin-list-item";
            item.setAttribute("data-id", id);
            item.setAttribute("data-nombre", app.nombre);
            item.setAttribute("data-icono", app.icono);
            item.setAttribute("data-desc", app.descripcion);
            item.setAttribute("data-link", app.link);
            
            item.innerHTML = `
                <span>${app.nombre}</span>
                <div class="btn-group">
                    <button class="btn-secondary edit-btn">Editar</button>
                    <button class="btn-danger delete-btn">Borrar</button>
                </div>
            `;
            adminAppList.appendChild(item);
        }
        
        // Clics en lista de admin (Editar/Borrar) (Sin cambios)
        adminAppList.addEventListener("click", (e) => {
            const target = e.target;
            const item = target.closest(".admin-list-item");
            if (!item) return;
            const appId = item.getAttribute("data-id");

            if (target.classList.contains("edit-btn")) {
                editIdInput.value = appId;
                appNombreInput.value = item.getAttribute("data-nombre");
                appIconoInput.value = item.getAttribute("data-icono");
                appDescInput.value = item.getAttribute("data-desc");
                appLinkInput.value = item.getAttribute("data-link");
                adminFormSubmitBtn.textContent = "Actualizar App";
                adminFormCancelBtn.style.display = "block";
                adminForm.scrollIntoView({ behavior: 'smooth' });
            }
            
            if (target.classList.contains("delete-btn")) {
                if (true) { // Reemplazado confirm()
                    deleteApp(appId);
                }
            }
        });
        
        // Borrar App (Sin cambios)
        async function deleteApp(id) {
            try {
                const appRef = doc(db, "apps", id);
                await deleteDoc(appRef);
                console.log("App eliminada con ID:", id);
                resetAdminForm(); 
            } catch (error) {
                console.error("Error al eliminar la app:", error);
            }
        }
        
        // Resetear Formulario (Sin cambios)
        adminFormCancelBtn.addEventListener("click", resetAdminForm);
        function resetAdminForm() {
            adminForm.reset();
            editIdInput.value = ""; 
            adminFormSubmitBtn.textContent = "Guardar App";
            adminFormCancelBtn.style.display = "none";
        }

        // --- CAMBIO AQUÍ (Nuevas funciones para SortableJS) ---
        
        /**
         * Inicializa SortableJS en la galería
         */
        function initSortable() {
            console.log("Activando modo de ordenamiento.");
            sortable = new Sortable(appGallery, {
                animation: 150, // Animación de reordenamiento
                ghostClass: 'sortable-ghost', // Clase CSS para el fantasma
                chosenClass: 'sortable-chosen', // Clase CSS para el item elegido
                onEnd: saveOrder // Función a llamar cuando se suelta el item
            });
        }

        /**
         * Se llama cuando el admin suelta una tarjeta.
         * Guarda el nuevo orden en Firebase usando un 'batch write'.
         */
        async function saveOrder() {
            console.log("Guardando nuevo orden...");
            const items = appGallery.children; // Obtiene todas las tarjetas en el nuevo orden del DOM
            
            // Un 'batch' nos permite hacer múltiples escrituras como una sola operación
            const batch = writeBatch(db);

            Array.from(items).forEach((item, index) => {
                const appId = item.getAttribute('data-id');
                if (appId) {
                    const appRef = doc(db, "apps", appId);
                    batch.update(appRef, { orden: index }); // Actualiza el campo 'orden' según su nueva posición
                }
            });

            try {
                await batch.commit(); // Envía todas las actualizaciones a Firebase
                console.log("¡Orden guardado exitosamente!");
            } catch (error) {
                console.error("Error al guardar el orden:", error);
            }
        }
        // --- FIN DEL CAMBIO ---

    </script>
</body>
</html>